# Lecture 9 电源管理 

**Outline**：

- Linux电源管理
- 安卓电源管理
- 唤醒锁
- 系统睡眠（挂起和唤醒）

-------



## 1. Linux电池管理

Linux两种常见的电源管理标准：

- **高级能源接口 APM** (Advanced Power Management)
- **高级配置和能源接口 ACPI** (Advanced Configuration and Power Interface)

------

#### 1.1 APM 高级能源管理

- **由BIOS控制，通过活动超时来确定何时关闭设备**，**在不通知操作系统或应用程序的情况下制定电源管理决策**，不兼容某些新硬件
- 电源管理发生的两种方式：
    - 从**APM驱动程序发起函数调用**，**向BIOS请求更改电源状态**
    - 根据设备的活动自动进行管理
- APM中的**电源状态**：
    -  Full On
    -  APM Enabled(开启节能)
    - APM Standby(待机)
    - APM Suspend(挂起)
    - Sleep/Hibernation(睡眠) 
    - Off
- APM的缺点：
    - 每个BIOS都有自己的策略，不同的计算机**缺乏一致性**
    - **无法知道系统挂起的原因**
    - **BIOS不知道用户在干什么**
    - **BIOS无法识别USB等外设的状态**

-------

#### 1.2 ACPI 高级配置与电源接口

- **由BIOS和操作系统协同完成，通过操作系统进行调整决策**，针对使用模式和硬件具有**统一标准的通用计算机** ，可以支持复杂的电源策略，但**不了解设备的具体情况**（无法判断不同电池状态下的响应时间各为多少）
- **基于操作系统的配置和电源管理** OSPM
- ACPI规范为ACPI兼容计算机系统定义了以下**四种全局 'Gx'状态**和**六种睡眠'Sx'状态**：
    - G0 (S0)：**工作中**。 ‘Awaymode’(离开模式)是S0的子集，表示显示 器关闭但后台任务正在运行
    - G1：**睡眠状态**
        - S1 : **刷新所有处理器的缓存**，**CPU停止执行命令**。**为CPU和RAM持续供电**，对其他没有使用的设备停止供电
        - S2: **停止对CPU供电，脏缓存刷新到RAM**
        - S3（**挂起到内存**） 也被称为待机(Linux)，睡眠(OSX)或挂 起到RAM(BIOS)。**RAM保持通电状态**
        - S4： 休眠/**挂起到磁盘** - **主内存的所有内容都保存到非易失性存储 器(如硬盘驱动器)中，并断电**
    - G2 (S5)：**Soft Off**（**G2仍可以通过网络（网卡依然唤醒状态）来唤醒计算机**）
    - G3：Mechanical Off，通过硬件开关完全断开计算机的电源
    - **Legacy State**：当**操作系统在不支持ACPI的情况下运行的状态**。在这个状态下，硬件和电源不是通过ACPI来管理的，**实际上已经禁用了ACPI**。

--------



## 2. 安卓电源管理

- 安卓电源管理是为移动设备设计的，**目标是延长电池寿命**
- 在Linux电源管理的上层建立：而非直接适用于移动设备
- 为具有“**默认处于关闭状态**”功能的设备设计

----------

#### 2.1 安卓电源管理设计

- 对Linux电源管理进行包装。内核中：
    - 添加了**‘on’ 电源状态**
    - 添加了**预挂起**框架
    - 添加了**部分唤醒锁**机制
- 应用程序和服务必须通过安卓应用程序框架和本机Linux库**使用“唤醒锁”来请求CPU资源，以保持通电，否则安卓将关闭 CPU**
- 安卓电源管理**使用唤醒锁和超时机制来切换系统电源状态**，从而降低系统能耗
- **安卓电源管理架构**：
    - 在此框架中，用户空间的应用程序可以**使用 “PowerManger”类来控制设备的电源状态**
    - 如果没有活动的唤醒锁，CPU会被关掉；如果有部分唤醒锁，屏幕和键盘将被关闭
    - 获取唤醒锁的步骤：
        - 通过调用Context.getSystemService()**获取PowerManager服务的句柄**(Handle)
        - **创建唤醒锁**并为屏幕，超时等指定电源管理标志
        - **获取唤醒锁**
        - **执行操作**，如播放MP3
        - **释放唤醒锁**
    - **电源管理状态机**：
        - 当**应用程序获得完全唤醒锁或发生屏幕/键盘触摸活动事件**时，机器将进入**AWAKE状态**
        - 如果**发生超时或按下电源键**，机器将进入**NOTIFICATION状态**
            - 如果**获得了部分唤醒锁，保持NOTIFICATION状态**
            - 如果**释放所有部分锁，进入SLEEP状态**

------



## 3. 唤醒锁

- **唤醒锁的类型**

    - ACQUIRE_CAUSES_WAKEUP（标志）：一般唤醒锁不会真的唤醒设备，只会使其在已经打开时保持打开状态。 例如将视频播放器应用视为正常行为。**设置该标志使得唤醒锁可以点亮屏幕**
    - ON_AFTER_RELEASE (标志）：设置用户活动计时器，释放此唤醒锁后，仍使屏幕保持打开状态一段时间。
    - ...

- **内核唤醒锁**：

    - 用于**防止系统进入挂起或低功耗状态**
    - 可以通过Power.c接口从应用程序获取/释放
        - **进程需要唤醒锁时询问内核是否有，若有则直接挂载在该内核唤醒锁的list即可，否则在内核中创建一个内核唤醒锁**（注意区分唤醒锁与内核唤醒锁）
    - 可以从内核获取/释放

- **唤醒锁的管理**：

    - **唤醒锁主要在Java层中进行管理**
    - **当安卓应用程序要获取唤醒锁时，会在PowerManagerService中注册一个新的唤醒锁实例**
    - 已注册的唤醒锁放在列表中

- **在内核中管理唤醒锁**：

    - **核中需要一个部分唤醒锁来保护Java中的部分唤醒锁实例**。该锁代表PowerManagerService类，名为

        PowerManagerService

    - 内核端的其他唤醒锁**可以通过Power.c API从Native代码获取**，**也可以在内核中获取**

    - 内核中有一个叫做**“main”的主唤醒锁**，用于**保证内核处于唤醒状态**

        - 系统挂起时释放的最后一个唤醒锁



