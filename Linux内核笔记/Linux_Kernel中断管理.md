# Linux Kernel中断管理`Interrupt Handling`

***Outline***：

- 中断和异常
- 中断处理
- 中断控制器
- *Linux* 中断处理过程：分为上下两个部分做
- 中断的上半部和下半部
- 软中断、*Tasklet*、*Workqueue*

----

## 1 中断和异常

- **轮询 *Pooling*** 和**中断 *Interrupt***
  - 轮询：**不断查询设备的状态，从而进行必要的 *I/O* 操作**（***CPU* 主动问**）
  - 中断：**设备在状态改变时主动发送一个信号给 *CPU***（**设备主动上报**），**通常被定义为一个事件，改变处理器执行的指令顺序**，与 *CPU* 芯片内外部硬件电路产生的电信号对应
  - 一般来说各有优劣：
    - 轮询：
      - 优点：简单、易实现、易控制，延迟较小，*CPU* 准备好即可
      - 缺点：系统开销大，浪费 *CPU* 资源（需要占据一整个 *CPU* 不断询问），无法感知设备状态变化
    - 中断：
      - 优点：节约系统处理器资源
      - 缺点：延迟较大（需要调用中断处理函数等，花销大），因此在吞吐量大时效率低；难实现、可遗漏信息
- 中断类别：
  - **同步中断 *Synchronous***：
    - 又称为**异常**
    - **由 *CPU* 控制单元在执行指令时产生**，通常是执行到某条非法指令，是**计划内的事情**
    - 又可分为：
      - **可屏蔽中断 *Maskable Interrupt***
      - **不可屏蔽中断 *Nonmaskable Interrupt***
  - **异步中断 *Asynchronous***：
    - 又称为**中断**
    - **由其他硬件设备产生**，产生时刻为 *CPU* 时钟信号发生的任何时刻，**系统计划外发生的事**，突发事件
    - 又可分为：
      - **处理器探测的异常 *Processor-detected Exception***
        - **故障 *Fault***：可以纠正，程序可在不失连贯性的情况下重新开始
        - **陷阱 *Trap***：执行完陷阱指令后，内核将控制权返回给程序后可以继续执行
        - **异常中止 *Abort***：发生严重错误，如硬件故障，控制权切换到异常中止处理程序
      - **程序异常 *Programmed Exception***

-----



## 2 中断处理

<img src="./pic/截屏2021-04-12 下午5.18.24.png" alt="avatar" style="zoom:35%;" />

- **中断处理的约束**：
  - 中断随时会到来，**应该尽可能快地处理完中断，尽可能地将更多的处理推迟**（中断分为上下部分，处理完上半部分即可返回，下半部分慢慢做）
  - 内核处理中断 *A* 时，另一个不同类型的中断又发生了，**中断嵌套**
  - 可维持更多的 *I/O* 设备处于忙状态
  - 处理程序必须支持嵌套
  - 内核代码中存在一些**临界区**，**在临界区必须禁止中断**
  - **尽量减少临界区**，以提高内核性能

- **中断处理函数**：
  - 处理中断响应，**不可被阻塞**（注意与中断嵌套区别）
  - 分为两个部分：**上半部**，**下半部**
    - 上半部：**只执行可以很快完成执行的代码**，如向硬件确认已收到的中断号
    - 下半部：**可延迟执行的工作**
  - **不能与用户空间进行直接的数据交换**
  - **不需要可重入**，即“不可以重新进入”
  - **不可休眠**，如 *ssleep()*、*msleep()* 等
  - 中断处理函数的注册：*request_irq()*

- **中断描述符表 *IDT, Interrupt Descriptor Table***
  - **每一种中断对应一个中断号**：*X86* 最多支持 *256* 种中断
  - ***IDT* 存放各中断对应的中断处理程序（的地址）**
  - 中断是 *CPU* 的机制，只要运行 *x86* 架构，*IDT*必然会存在
  - ***IDT* 中的中断处理程序由 *OS* 提供**，*OS* 保留 *32* 个，其余中断号对应的中断处理函数可以自行定义
  - *IDT* 是一个最大为 *256* 项的表，每个表项为 *8* 字节，称为 **中断门**
    - **任务门 *Task Gate***
      - 当中断信号发生时，必须取代当前进程的那个进程的**任务状态段 *TSS***选择符存放在任务门中

